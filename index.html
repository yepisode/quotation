<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>품목 글자 쓰기 & 계산</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .drawing-section {
            padding: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .drawing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .drawing-header h2 {
            color: #333;
            font-size: 18px;
        }

        .drawing-controls {
            display: flex;
            gap: 8px;
        }

        .control-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .control-btn.clear {
            background: #ff4757;
        }

        .control-btn.clear:hover {
            background: #ff3742;
        }

        #canvas {
            width: 100%;
            height: 180px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            cursor: crosshair;
            background: #fafafa;
            touch-action: none;
        }

        #specCanvas {
            width: 100%;
            height: 120px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            cursor: crosshair;
            background: #fafafa;
            touch-action: none;
        }

        .pen-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .pen-size {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pen-size label {
            font-size: 14px;
            color: #666;
        }

        .pen-size input {
            width: 60px;
        }

        .color-picker {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .color-option {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .color-option:hover, .color-option.active {
            transform: scale(1.2);
            border-color: #333;
        }

        .input-section {
            padding: 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 16px;
        }

        .input-field {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 20px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .result-section {
            padding: 20px;
            background: #f8f9fa;
            border-top: 2px solid #e0e0e0;
        }

        .totals {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .subtotal, .tax {
            display: flex;
            justify-content: space-between;
            font-size: 16px;
            color: #666;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .result {
            display: flex;
            justify-content: space-between;
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 2px solid #667eea;
        }

        .calculate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .calculate-btn.update {
            background: linear-gradient(45deg, #2ed573, #1dd1a1);
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .calculate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .cancel-btn {
            width: 100%;
            padding: 12px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .cancel-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .items-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .item-drawing {
            width: 60px;
            height: 40px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 12px;
            background: white;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .item-details {
            font-size: 14px;
            color: #666;
            margin-bottom: 2px;
        }

        .item-subtotal {
            font-size: 14px;
            color: #888;
            margin-bottom: 2px;
        }

        .item-total {
            font-weight: 700;
            color: #667eea;
            font-size: 16px;
        }

        .item-actions {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-left: 10px;
        }

        .edit-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .edit-btn:hover {
            background: #5a67d8;
            transform: scale(1.05);
        }

        .delete-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .delete-btn:hover {
            background: #ff3742;
            transform: scale(1.05);
        }

        .empty-state {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 20px;
        }

        .active-input {
            border-color: #667eea !important;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2) !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>품목 관리</h1>
            <p>펜으로 품목명을 쓰고 계산해보세요</p>
        </div>

        <div class="drawing-section">
            <div class="drawing-header">
                <h2>품목명 쓰기</h2>
                <div class="drawing-controls">
                    <button class="control-btn" onclick="undo()">되돌리기</button>
                    <button class="control-btn clear" onclick="clearCanvas()">지우기</button>
                </div>
            </div>
            <canvas id="canvas"></canvas>
            

        </div>

        <div class="input-section">
            <div class="input-group">
                <label for="itemName">품목명 (선택사항)</label>
                <input type="text" id="itemName" class="input-field" placeholder="품목명 입력 (미입력시 그림 사용)" style="font-size: 16px; text-align: left;">
            </div>
            
            <div class="input-group">
                <label for="quantity">수량 (선택사항)</label>
                <input type="number" id="quantity" class="input-field" placeholder="수량 (미입력시 1개)" inputmode="decimal" step="any">
            </div>

            <div class="input-group">
                <label for="price">단가 (원)</label>
                <input type="number" id="price" class="input-field" placeholder="단가를 입력하세요" inputmode="decimal" step="0.01">
            </div>

            <button class="calculate-btn" onclick="addOrUpdateItem()" id="addBtn">품목 추가</button>
            <button class="cancel-btn" onclick="cancelEdit()" id="cancelBtn" style="display: none;">수정 취소</button>
        </div>

        <div class="result-section">
            <div class="totals">
                <div class="subtotal">소계: <span id="subtotal">0</span>원</div>
                <div class="tax">세금(10%): <span id="tax">0</span>원</div>
                <div class="result">총액: <span id="total">0</span>원</div>
            </div>
            <div class="items-list" id="itemsList">
                <div class="empty-state">추가된 품목이 없습니다</div>
            </div>
        </div>
    </div>

    <script>
        // Canvas 설정
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let items = [];
        let currentColor = '#333';
        let currentLineWidth = 2;
        let drawingHistory = [];
        let editingItemId = null;

        // Canvas 크기 설정
        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * 2;
            canvas.height = rect.height * 2;
            ctx.scale(2, 2);
            
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = currentLineWidth;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }

        // 초기 설정
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // 그리기 시작 전 상태 저장
        function saveState() {
            drawingHistory.push(canvas.toDataURL());
            if (drawingHistory.length > 10) {
                drawingHistory.shift();
            }
        }

        // 되돌리기 기능
        function undo() {
            if (drawingHistory.length > 0) {
                const lastState = drawingHistory.pop();
                const img = new Image();
                img.onload = function() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width/2, canvas.height/2);
                };
                img.src = lastState;
            }
        }

        // 그리기 이벤트
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        // 터치 이벤트 (모바일)
        canvas.addEventListener('touchstart', handleTouch, { passive: false });
        canvas.addEventListener('touchmove', handleTouch, { passive: false });
        canvas.addEventListener('touchend', stopDrawing, { passive: false });

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;

            if (e.type === 'touchstart') {
                startDrawing({ offsetX: x, offsetY: y });
            } else if (e.type === 'touchmove') {
                draw({ offsetX: x, offsetY: y });
            }
        }

        function startDrawing(e) {
            saveState();
            isDrawing = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        }

        function draw(e) {
            if (!isDrawing) return;
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
            updateAddButton();
        }

        function clearCanvas() {
            saveState();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            updateAddButton();
        }

        function updatePenSize() {
            const size = document.getElementById('penSize').value;
            currentLineWidth = size;
            ctx.lineWidth = size;
            document.getElementById('sizeDisplay').textContent = size + 'px';
        }

        function changeColor(color) {
            currentColor = color;
            ctx.strokeStyle = color;
            
            // 색상 선택 표시 업데이트
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // 입력 필드 이벤트 리스너
        document.getElementById('quantity').addEventListener('input', updateAddButton);
        document.getElementById('price').addEventListener('input', updateAddButton);

        // 숫자만 입력 허용 (소수점 포함)
        function validateNumberInput(e) {
            const value = e.target.value;
            const regex = /^\d*\.?\d*$/;
            if (!regex.test(value)) {
                e.target.value = value.slice(0, -1);
            }
        }

        document.getElementById('quantity').addEventListener('input', validateNumberInput);
        document.getElementById('price').addEventListener('input', validateNumberInput);

        // 추가 버튼 상태 업데이트
        function updateAddButton() {
            const itemName = document.getElementById('itemName').value.trim();
            const price = document.getElementById('price').value;
            const hasDrawing = !isCanvasEmpty();
            
            const addBtn = document.getElementById('addBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            
            if (editingItemId) {
                // 수정 모드 - 기존 데이터가 있으면 품목명 조건을 완화
                const existingItem = items.find(item => item.id === editingItemId);
                const hasExistingItemData = existingItem && (existingItem.hasTextName || existingItem.hasDrawnImage);
                
                addBtn.classList.add('update');
                addBtn.textContent = '수정 완료';
                cancelBtn.style.display = 'block';
                
                if (price && (itemName || hasDrawing || hasExistingItemData)) {
                    addBtn.disabled = false;
                } else {
                    addBtn.disabled = true;
                }
            } else {
                // 추가 모드
                addBtn.classList.remove('update');
                addBtn.textContent = '품목 추가';
                cancelBtn.style.display = 'none';
                
                if (price && (itemName || hasDrawing)) {
                    addBtn.disabled = false;
                } else {
                    addBtn.disabled = true;
                    if (!price) {
                        addBtn.textContent = '단가를 입력하세요';
                    } else if (!itemName && !hasDrawing) {
                        addBtn.textContent = '품목명을 입력하거나 그려주세요';
                    }
                }
            }
        }

        // 캔버스가 비어있는지 확인
        function isCanvasEmpty() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            return imageData.data.every(pixel => pixel === 0);
        }

        // 품목 추가 또는 수정
        function addOrUpdateItem() {
            if (editingItemId) {
                updateItem();
            } else {
                addItem();
            }
        }

        // 품목 추가
        function addItem() {
            const itemNameInput = document.getElementById('itemName').value.trim();
            const quantityInput = document.getElementById('quantity').value;
            const quantity = quantityInput ? parseFloat(quantityInput) : 1;
            const price = parseFloat(document.getElementById('price').value);
            
            if (!price) return;
            
            const hasItemName = itemNameInput.length > 0;
            const hasDrawing = !isCanvasEmpty();
            
            if (!hasItemName && !hasDrawing) return;

            const itemData = createItemData(itemNameInput, hasItemName, hasDrawing, quantity, price);
            items.push(itemData);
            
            updateItemsList();
            updateTotals();
            clearForm();
        }

        // 품목 수정
        function updateItem() {
            const itemNameInput = document.getElementById('itemName').value.trim();
            const quantityInput = document.getElementById('quantity').value;
            const quantity = quantityInput ? parseFloat(quantityInput) : 1;
            const price = parseFloat(document.getElementById('price').value);
            
            if (!price) return;
            
            const hasItemName = itemNameInput.length > 0;
            const hasDrawing = !isCanvasEmpty();
            
            // 기존 아이템에서 원본 데이터 가져오기
            const existingItem = items.find(item => item.id === editingItemId);
            
            let itemDisplay = '';
            let thumbnailData = '';
            let hasTextName = false;
            let hasDrawnImage = false;
            let originalTextName = '';
            let originalDrawing = '';

            if (hasItemName) {
                // 새로 텍스트를 입력한 경우
                itemDisplay = itemNameInput;
                thumbnailData = createTextThumbnail(itemNameInput);
                hasTextName = true;
                originalTextName = itemNameInput;
            } else if (hasDrawing) {
                // 새로 그림을 그린 경우
                itemDisplay = '(그림)';
                thumbnailData = createDrawingThumbnail();
                hasDrawnImage = true;
                originalDrawing = canvas.toDataURL();
            } else if (existingItem) {
                // 기존 데이터 유지
                itemDisplay = existingItem.name;
                thumbnailData = existingItem.drawing;
                hasTextName = existingItem.hasTextName;
                hasDrawnImage = existingItem.hasDrawnImage;
                originalTextName = existingItem.originalTextName;
                originalDrawing = existingItem.originalDrawing;
            }

            const subtotal = quantity * price;
            const tax = subtotal * 0.1;
            const total = subtotal + tax;

            const updatedItem = {
                id: editingItemId,
                name: itemDisplay,
                drawing: thumbnailData,
                quantity: quantity,
                price: price,
                subtotal: subtotal,
                tax: tax,
                total: total,
                quantityEntered: document.getElementById('quantity').value.trim() !== '',
                hasTextName: hasTextName,
                hasDrawnImage: hasDrawnImage,
                originalTextName: originalTextName,
                originalDrawing: originalDrawing
            };

            const itemIndex = items.findIndex(item => item.id === editingItemId);
            if (itemIndex !== -1) {
                items[itemIndex] = updatedItem;
            }
            
            updateItemsList();
            updateTotals();
            clearForm();
            exitEditMode();
        }

        // 품목 데이터 생성 (공통 함수)
        function createItemData(itemNameInput, hasItemName, hasDrawing, quantity, price, existingId = null) {
            let itemDisplay = '';
            let thumbnailData = '';
            let hasTextName = false;
            let hasDrawnImage = false;

            if (hasItemName) {
                // 텍스트 입력이 있으면 텍스트 우선
                itemDisplay = itemNameInput;
                thumbnailData = createTextThumbnail(itemNameInput);
                hasTextName = true;
            } else if (hasDrawing) {
                // 텍스트 입력이 없고 그림만 있으면 그림 사용
                itemDisplay = '(그림)';
                thumbnailData = createDrawingThumbnail();
                hasDrawnImage = true;
            }

            const subtotal = quantity * price;
            const tax = subtotal * 0.1;
            const total = subtotal + tax;

            return {
                id: existingId || Date.now(),
                name: itemDisplay,
                drawing: thumbnailData,
                quantity: quantity,
                price: price,
                subtotal: subtotal,
                tax: tax,
                total: total,
                quantityEntered: document.getElementById('quantity').value.trim() !== '', // 수량 입력 여부 저장
                hasTextName: hasTextName, // 텍스트 품목명 여부
                hasDrawnImage: hasDrawnImage, // 그림 품목명 여부
                originalTextName: hasTextName ? itemNameInput : '', // 원본 텍스트명 저장
                originalDrawing: hasDrawnImage ? canvas.toDataURL() : '' // 원본 그림 데이터 저장
            };
        }

        // 텍스트 썸네일 생성
        function createTextThumbnail(text) {
            const textCanvas = document.createElement('canvas');
            textCanvas.width = 120;
            textCanvas.height = 80;
            const textCtx = textCanvas.getContext('2d');
            textCtx.fillStyle = 'white';
            textCtx.fillRect(0, 0, 120, 80);
            textCtx.fillStyle = '#333';
            textCtx.font = '14px sans-serif';
            textCtx.textAlign = 'center';
            textCtx.textBaseline = 'middle';
            
            const maxWidth = 110;
            const words = text.split(' ');
            let line = '';
            let y = 30;
            
            for (let i = 0; i < words.length; i++) {
                const testLine = line + words[i] + ' ';
                const metrics = textCtx.measureText(testLine);
                const testWidth = metrics.width;
                
                if (testWidth > maxWidth && i > 0) {
                    textCtx.fillText(line, 60, y);
                    line = words[i] + ' ';
                    y += 20;
                } else {
                    line = testLine;
                }
            }
            textCtx.fillText(line, 60, y);
            
            return textCanvas.toDataURL();
        }

        // 그림 썸네일 생성
        function createDrawingThumbnail() {
            const thumbnailCanvas = document.createElement('canvas');
            thumbnailCanvas.width = 120;
            thumbnailCanvas.height = 80;
            const thumbnailCtx = thumbnailCanvas.getContext('2d');
            thumbnailCtx.fillStyle = 'white';
            thumbnailCtx.fillRect(0, 0, 120, 80);
            thumbnailCtx.drawImage(canvas, 0, 0, 120, 80);
            
            return thumbnailCanvas.toDataURL();
        }

        // 품목 수정 모드 진입
        function editItem(id) {
            const item = items.find(item => item.id === id);
            if (!item) return;

            editingItemId = id;
            
            // 폼에 기존 데이터 입력
            if (item.hasTextName) {
                // 텍스트 품목명이 있는 경우
                document.getElementById('itemName').value = item.originalTextName;
            } else {
                document.getElementById('itemName').value = '';
            }

            if (item.hasDrawnImage && item.originalDrawing) {
                // 그림 품목명이 있는 경우 - 캔버스에 복원
                restoreDrawingToCanvas(item.originalDrawing);
            }
            
            // 수량이 실제로 입력되었었는지에 따라 처리
            if (item.quantityEntered) {
                document.getElementById('quantity').value = item.quantity;
            } else {
                document.getElementById('quantity').value = '';
            }
            document.getElementById('price').value = item.price;
            
            updateAddButton();
            
            // 스크롤을 입력 폼으로 이동
            document.querySelector('.input-section').scrollIntoView({ behavior: 'smooth' });
        }

        // 캔버스에 그림 복원
        function restoreDrawingToCanvas(drawingData) {
            const img = new Image();
            img.onload = function() {
                // 캔버스 크기에 맞게 그림 복원
                const rect = canvas.getBoundingClientRect();
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, rect.width, rect.height);
            };
            img.src = drawingData;
        }

        // 수정 취소
        function cancelEdit() {
            exitEditMode();
            clearForm();
        }

        // 수정 모드 종료
        function exitEditMode() {
            editingItemId = null;
            updateAddButton();
        }

        // 폼 초기화
        function clearForm() {
            document.getElementById('itemName').value = '';
            document.getElementById('quantity').value = '';
            document.getElementById('price').value = '';
            clearCanvas();
            drawingHistory = [];
            updateAddButton();
        }

        // 품목 목록 업데이트
        function updateItemsList() {
            const itemsList = document.getElementById('itemsList');
            
            if (items.length === 0) {
                itemsList.innerHTML = '<div class="empty-state">추가된 품목이 없습니다</div>';
                return;
            }

            itemsList.innerHTML = items.map(item => {
                const quantityDisplay = item.quantityEntered ? `<div class="item-details">수량: ${item.quantity.toLocaleString()}</div>` : '';
                
                return `
                <div class="item">
                    <img src="${item.drawing}" alt="품목 그림" class="item-drawing">
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        ${quantityDisplay}
                        <div class="item-details">단가: ${item.price.toLocaleString()}원</div>
                        <div class="item-subtotal">${item.subtotal.toLocaleString()}원</div>
                        <div class="item-total">세금 포함: ${item.total.toLocaleString()}원</div>
                    </div>
                    <div class="item-actions">
                        <button class="edit-btn" onclick="editItem(${item.id})">수정</button>
                        <button class="delete-btn" onclick="deleteItem(${item.id})">삭제</button>
                    </div>
                </div>
            `}).join('');
        }

        // 품목 삭제
        function deleteItem(id) {
            items = items.filter(item => item.id !== id);
            updateItemsList();
            updateTotals();
        }

        // 총액 업데이트
        function updateTotals() {
            const subtotal = items.reduce((sum, item) => sum + item.subtotal, 0);
            const tax = items.reduce((sum, item) => sum + item.tax, 0);
            const total = items.reduce((sum, item) => sum + item.total, 0);
            
            document.getElementById('subtotal').textContent = subtotal.toLocaleString();
            document.getElementById('tax').textContent = tax.toLocaleString();
            document.getElementById('total').textContent = total.toLocaleString();
        }

        // 초기 상태 설정
        updateAddButton();
    </script>
</body>
</html>